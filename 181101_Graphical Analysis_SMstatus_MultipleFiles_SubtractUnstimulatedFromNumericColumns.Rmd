---
title: "Luminex_DataAnalysis"
author: "Elise Viox"
date: "October 31, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
```

##R Markdown
#Analyze Data
##Subtract out unstimulated values
###Generate Practice Luminex Data
A practice table was created with data similar to what we might obtain from running Luminex.
```{r Create Data Table #1}
#Create "fake1" datatable
library(knitr)
library(data.table)
donor<-c(rep("A_SMpos", 6), rep("B_SMneg",6), rep("C_SMneg",6), rep("D_SMneg",6), rep("E_SMpos",6), rep("F_SMpos",6), rep("G_SMneg",6), rep("H_SMneg",6), rep("I_SMneg",6), rep("J_SMpos",6), rep("K_SMpos",6), rep("L_SMpos",6), rep("M_SMpos", 6))
stim<-rep(c("un","w","p","s","sw","sb"),3)
ifng<-rnorm(70, 2)
tnfa<-rnorm(70,10)
IL4<-rnorm(70,5)
IL5<-rnorm(70,7)
IL10<-rnorm(70,13)
IL13<-rnorm(70,19)
IL17<-rnorm(70,17)
IL21<-rnorm(70,11)
IL22<-rnorm(70,3)

fake1<-as.data.table(cbind(donor,stim,ifng,tnfa,IL4, IL5, IL10, IL13, IL17, IL21, IL22))
fake1$ifng=as.numeric(as.character(fake1$ifng))
fake1$tnfa=as.numeric(as.character(fake1$tnfa))
fake1$IL4=as.numeric(as.character(fake1$IL4))
fake1$IL5=as.numeric(as.character(fake1$IL5))
fake1$IL10=as.numeric(as.character(fake1$IL10))
fake1$IL13=as.numeric(as.character(fake1$IL13))
fake1$IL17=as.numeric(as.character(fake1$IL17))
fake1$IL21=as.numeric(as.character(fake1$IL21))
fake1$IL22=as.numeric(as.character(fake1$IL22))

#Print "fake1" and "fake2" datatables 
library(knitr)
kable(fake1)

#Write "fake1" csv
setwd("/Users/eviox/Documents/Emory_IMP/Rotations/Day_Lab/Luminex/FakeData/")
write.csv(fake1,"fake1.csv")
```

```{r Create Data Table #2}
#Create "fake2" datatable
library(knitr)
library(data.table)
donor<-c(rep("N_SMpos",6), rep("O_SMpos",6), rep("P_SMpos",6), rep("Q_SMneg",6), rep("R_SMpos",6), rep("S_SMneg",6), rep("T_SMneg",6), rep("U_SMneg",6), rep("V_SMneg",6), rep("W_SMpos",6), rep("X_SMpos",6), rep("Y_SMneg", 6), rep("Z_SMpos", 6))
stim<-rep(c("un","w","p","s","sw","sb"),3)
ifng<-rnorm(70, 2)
tnfa<-rnorm(70,10)
IL4<-rnorm(70,5)
IL5<-rnorm(70,7)
IL10<-rnorm(70,13)
IL13<-rnorm(70,19)
IL17<-rnorm(70,17)
IL21<-rnorm(70,11)
IL22<-rnorm(70,3)

fake2<-as.data.table(cbind(donor,stim,ifng,tnfa,IL4, IL5, IL10, IL13, IL17, IL21, IL22))
fake2$ifng=as.numeric(as.character(fake1$ifng))
fake2$tnfa=as.numeric(as.character(fake1$tnfa))
fake2$IL4=as.numeric(as.character(fake1$IL4))
fake2$IL5=as.numeric(as.character(fake1$IL5))
fake2$IL10=as.numeric(as.character(fake1$IL10))
fake2$IL13=as.numeric(as.character(fake1$IL13))
fake2$IL17=as.numeric(as.character(fake1$IL17))
fake2$IL21=as.numeric(as.character(fake1$IL21))
fake2$IL22=as.numeric(as.character(fake1$IL22))

#Print "fake2" datatables 
library(knitr)
kable(fake2)

#Write "fake2" csv
setwd("/Users/eviox/Documents/Emory_IMP/Rotations/Day_Lab/Luminex/FakeData/")
write.csv(fake2,"fake2.csv")
```

```{r}

library(data.table)  

file_names <- dir("/Users/eviox/Documents/Emory_IMP/Rotations/Day_Lab/Luminex/FakeData/") #where you have your files
setwd("/Users/eviox/Documents/Emory_IMP/Rotations/Day_Lab/Luminex/FakeData/")
fakecombined <- do.call(rbind,lapply(file_names,read.csv))
fakecombined$X <- NULL

```

###Subtract out unstimulated values
I wrote a function called "subtractun"" that pulls the unstimulated value for each cytokine from each donor and subtracts it from the respective stim values for the respective cytokine. 

The function uses the 1) split, 2) apply, 3)combine sequence to 1) generate data tables for each individual donor, 2) apply the subtraction of the unstim to the respective cytokines for those donors, and 3) take these newly calculated values for individual donors and combine them into a data table containing all donor values.

The subtractun function will be applied only to the numeric columns of a datatable as specified by the "numeric.only" function. In the case of luminex data, this ensures that the function will only be applied to cytokine data. 

###Split table by donor
```{r Split Table}
library(knitr)
#Redefine donor (since previously defined for generating fake data)
donor<-fakecombined$donor
fakesplit<- split(fakecombined, donor)
kable(fakesplit$A)
kable(fakesplit$B)
kable(fakesplit$C)
kable(fakesplit$D)
kable(fakesplit$E)
kable(fakesplit$F)
```

```{r Create Split, Apply, Combine Function}
#pred_precipitation[pred_precipitation<0] <- 0

subtractun<-function (datatable) {
  #Split datatable by donor    
    y<- split(datatable, donor)
  #Write function that will select numeric columns of datatable
    numeric.only <- function(X,...){
      returnCols <- names(X)
      a<-sapply(X, is.numeric)
      print(returnCols[a == "TRUE"])
      }
    #Apply numeric.only function to datatable
    for (z in numeric.only(datatable)){
  #Subtract out unstim value from respective stim cytokine values
    newcolumn<-unlist(lapply(y,function(g)
      (g[,z]- as.matrix(subset(g[,z], g$stim=="un"))[1,1])
      ))
  #Create new datatable with unstim substractions applied to all donors 
    datatable[,z] <- newcolumn}
    datatable
      }  
```

```{r Apply function to data table of interest}
#Apply subtractun function to datatable of interest
newfake<-subtractun(fakecombined)
newfake[newfake<0] <- 0
library(knitr)
kable(newfake)
library(dplyr)
library(tidyr)
newfake %>%
  separate(donor, c("donor", "Status"), "_")

#library(stringr)
#donorstringsplit<-str_split_fixed(newfake$donor, "_", 2)
```

```{r}
library(ggplot2)
qplot(x=donor, y=ifng, data=newfake, color=stim)
qplot(x=donor, y=tnfa, data=newfake, color=stim)


#for (z in numeric.only(newfake)){
#qplot(x=donor, y=z, data=newfake, color=stim)}

##add line in subtractun for converting negative values to zero

```


```{r Graph Volcano Plot}

with(newfake, plot(log2FoldChange, -log10(pvalue), pch=20, main="Volcano plot", xlim=c(-2.5,2)))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
