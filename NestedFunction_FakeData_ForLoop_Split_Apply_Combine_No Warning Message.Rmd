---
title: "Luminex_DataAnalysis"
author: "Elise Viox"
date: "October 28, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
```

## R Markdown
#Analyze Data
##Subtract out unstimulated values
###Generate Practice Luminex Data
A practice table was created with data similar to what we might obtain from running Luminex.
```{r Load Data}
#Create "fake" datatable
library(knitr)
library(data.table)
donor<-c(rep("A", 6), rep("B",6), rep("C",6))
stim<-rep(c("un","w","p","s","sw","sb"),3)
ifng<-rnorm(18, 2)
tnfa<-rnorm(18,10)
fake<-as.data.table(cbind(donor,stim,ifng,tnfa))
fake$ifng=as.numeric(as.character(fake$ifng))
fake$tnfa=as.numeric(as.character(fake$tnfa))
#Print "fake" datatable 
library(knitr)
kable(fake)
```


###Split table by donor
```{r Split Table}
library(knitr)
y<- split(fake, donor)
kable(y$A)
kable(y$B)
kable(y$C)
```

###Subtract out unstimulated values
I wrote a function called "subtractun"" that pulls the unstim value for each cytokine from each donor and subtracts it from the respective stim values for the respective cytokine. The function uses the 1) split, 2) apply, 3)combine sequence to 1) generate data tables for each individual donor, 2) apply the subtraction of the unstim to the respective cytokines for those donors, and 3) take these newly calculated values for individual donors and combine them into a data table containing all donor values.
```{r Create Split, Apply, Combine Function}
for (i in 1:ncol(fake)){
  if(is.numeric(fake[[i]])){
    subtractun<-function (datatable,column) {
      #Split full data table into smaller data tables for each individual donor 
      y<- split(datatable, donor)
      #Subtract out unstim
      newcolumn<-unlist(lapply(y,function(g)
        (g[,..column]- as.matrix(subset(g[,..column], g$stim=="un"))[1,1])
      ))
      ##Merge donor and stim condition to create new sample ID
      ###newsampleid<- paste(donor, stim, sep= "_")
      #Create new datatable with unstim substractions applied to all donors 
      datatable[,column] <- newcolumn
      datatable
    }
  }
}

```

```{r Apply function to data table of interest}
newnewfake<-subtractun(fake,"tnfa")
newnewnewfake<-subtractun(newnewfake,"ifng")
library(knitr)
kable(newnewnewfake)
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
